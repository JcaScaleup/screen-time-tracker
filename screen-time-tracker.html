<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Time Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f0f5;
            color: #1c1c1e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 16px;
        }

        .container {
            width: 100%;
            max-width: 480px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        /* Tab bar */
        .tab-bar {
            display: flex;
            background: #e5e5ea;
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 0;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #8e8e93;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: #1c1c1e;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .card.total {
            background: #007aff;
            color: #fff;
        }

        .card.other {
            background: #5856d6;
            color: #fff;
        }

        .card.date-card {
            background: #34c759;
            color: #fff;
        }

        .card.checkin-header-card {
            background: #ff9500;
            color: #fff;
        }

        .card-label {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            opacity: 0.85;
        }

        .card.total .card-label,
        .card.other .card-label,
        .card.date-card .card-label,
        .card.checkin-header-card .card-label {
            opacity: 1;
            color: rgba(255, 255, 255, 0.85);
        }

        /* Time inputs */
        .time-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-field {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .time-field input {
            width: 72px;
            height: 48px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            text-align: center;
            font-size: 22px;
            font-weight: 600;
            outline: none;
            transition: border-color 0.2s;
            background: #fff;
            color: #1c1c1e;
        }

        .time-field input:focus {
            border-color: #007aff;
        }

        .card.total .time-field input {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .card.total .time-field input:focus {
            border-color: rgba(255, 255, 255, 0.7);
        }

        .card.total .time-field input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .time-field label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #8e8e93;
        }

        .card.total .time-field label,
        .card.other .time-field label {
            color: rgba(255, 255, 255, 0.7);
        }

        .time-separator {
            font-size: 24px;
            font-weight: 700;
            margin-top: -16px;
        }

        /* Other display */
        .other-display {
            font-size: 36px;
            font-weight: 700;
        }

        .other-display .unit {
            font-size: 16px;
            font-weight: 500;
            opacity: 0.8;
        }

        /* App icons */
        .app-icon {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            margin-right: 10px;
            vertical-align: middle;
            text-align: center;
            line-height: 32px;
            font-size: 16px;
            color: #fff;
            flex-shrink: 0;
        }

        .app-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .app-header .card-label {
            margin-bottom: 0;
        }

        .icon-facebook { background: #1877f2; }
        .icon-instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .icon-snapchat { background: #fffc00; color: #000; }
        .icon-news { background: #ff3b30; }
        .icon-chess { background: #4a752c; }
        .icon-games { background: #5856d6; }
        .icon-youtube { background: #ff0000; }

        .warning {
            color: #ff3b30;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            display: none;
        }

        .card.other .warning {
            color: #ffcc00;
        }

        .summary {
            text-align: center;
            font-size: 13px;
            color: #8e8e93;
            margin-top: 8px;
        }

        /* Date picker */
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-inputs input[type="date"] {
            flex: 1;
            height: 48px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            padding: 0 12px;
            outline: none;
            transition: border-color 0.2s;
        }

        .date-inputs input[type="date"]:focus {
            border-color: rgba(255, 255, 255, 0.7);
        }

        .date-inputs input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .date-status {
            font-size: 13px;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.75);
            min-height: 18px;
        }

        /* Buttons */
        .btn-today {
            height: 48px;
            padding: 0 16px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .btn-today:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .save-area {
            margin-bottom: 16px;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: #34c759;
            color: #fff;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.85;
        }

        .btn-skip {
            width: 100%;
            padding: 16px;
            border: 2px solid #8e8e93;
            border-radius: 12px;
            background: transparent;
            color: #8e8e93;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-skip:hover {
            background: rgba(142, 142, 147, 0.1);
        }

        .btn-small {
            padding: 6px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-small:hover {
            opacity: 0.8;
        }

        .btn-edit {
            background: #007aff;
            color: #fff;
        }

        .btn-delete {
            background: #ff3b30;
            color: #fff;
        }

        /* Toggle buttons */
        .toggle-question {
            margin-bottom: 8px;
        }

        .toggle-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .toggle-group {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px 0;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            background: #fff;
            font-size: 15px;
            font-weight: 600;
            color: #8e8e93;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .toggle-btn.selected-yes {
            border-color: #34c759;
            background: #34c759;
            color: #fff;
        }

        .toggle-btn.selected-no {
            border-color: #ff3b30;
            background: #ff3b30;
            color: #fff;
        }

        /* Slider */
        .slider-container {
            text-align: center;
        }

        .slider-value {
            font-size: 48px;
            font-weight: 700;
            color: #ff9500;
            margin-bottom: 8px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #8e8e93;
            margin-bottom: 4px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e5ea;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ff9500;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ff9500;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Checkin panel */
        .checkin-panel {
            display: none;
        }

        .checkin-panel.active {
            display: block;
        }

        .checkin-date-display {
            font-size: 18px;
            font-weight: 700;
        }

        .checkin-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        /* History */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header .card-label {
            margin-bottom: 0;
        }

        .history-count {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 500;
        }

        .history-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-size: 15px;
            font-weight: 600;
        }

        .history-total {
            font-size: 20px;
            font-weight: 700;
            color: #007aff;
        }

        .history-apps {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .app-pill {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }

        .app-pill.snap-pill {
            color: #1c1c1e;
        }

        .history-checkin {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f5;
        }

        .checkin-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: #f0f0f5;
            color: #1c1c1e;
        }

        .checkin-badge.positive {
            background: #d4f5dc;
            color: #1b7a2e;
        }

        .checkin-badge.negative {
            background: #fde8e8;
            color: #c0392b;
        }

        .checkin-badge.rating {
            background: #fff3e0;
            color: #e67e22;
            font-size: 13px;
            font-weight: 700;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8e8e93;
            font-size: 15px;
            line-height: 1.5;
        }

        /* Charts */
        .chart-section {
            margin-bottom: 16px;
        }

        .chart-section canvas {
            max-height: 250px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1c1c1e;
            color: #fff;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Screen Time Tracker</h1>

        <div class="tab-bar" id="tab-bar">
            <button class="tab-btn active" data-tab="input">Input</button>
            <button class="tab-btn" data-tab="history">History</button>
            <button class="tab-btn" data-tab="charts">Charts</button>
        </div>

        <!-- INPUT TAB -->
        <div class="tab-panel active" id="panel-input">

            <div class="card date-card">
                <div class="card-label">Date</div>
                <div class="date-inputs">
                    <input type="date" id="entry-date" pattern="\d{4}-\d{2}-\d{2}">
                    <button class="btn-today" id="btn-today">Today</button>
                </div>
                <div class="date-status" id="date-status"></div>
            </div>

            <div class="card total">
                <div class="card-label">Total Screen Time</div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" id="total-h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" id="total-m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-facebook">f</span>
                    <span class="card-label">Facebook</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="facebook" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="facebook" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-instagram">&#9737;</span>
                    <span class="card-label">Instagram</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="instagram" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="instagram" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-snapchat">&#9781;</span>
                    <span class="card-label">Snapchat</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="snapchat" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="snapchat" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-news">&#9993;</span>
                    <span class="card-label">News</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="news" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="news" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-chess">&#9822;</span>
                    <span class="card-label">Chess</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="chess" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="chess" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-games">&#9654;</span>
                    <span class="card-label">Games</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="games" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="games" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="app-header">
                    <span class="app-icon icon-youtube">&#9654;</span>
                    <span class="card-label">YouTube</span>
                </div>
                <div class="time-inputs">
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="youtube" data-unit="h" min="0" max="24" placeholder="0" oninput="calculate()">
                        <label>Hours</label>
                    </div>
                    <span class="time-separator">:</span>
                    <div class="time-field">
                        <input type="number" class="app-time" data-app="youtube" data-unit="m" min="0" max="59" placeholder="0" oninput="calculate()">
                        <label>Minutes</label>
                    </div>
                </div>
            </div>

            <div class="card other">
                <div class="card-label">Other (calculated)</div>
                <div class="other-display" id="other-display">
                    0<span class="unit">h</span> 0<span class="unit">m</span>
                </div>
                <div class="warning" id="warning">App times exceed total screen time.</div>
                <div class="summary" id="summary" style="color: rgba(255,255,255,0.6);"></div>
            </div>

            <div class="save-area">
                <button class="btn-primary" id="btn-save">Save Entry</button>
            </div>
        </div>

        <!-- DAILY CHECK-IN (not a tab, a step after save) -->
        <div class="checkin-panel" id="panel-checkin">
            <div class="card checkin-header-card">
                <div class="card-label">Daily Check-in</div>
                <div class="checkin-date-display" id="checkin-date-display"></div>
            </div>

            <div class="card toggle-question">
                <div class="toggle-label">Did you workout today?</div>
                <div class="toggle-group">
                    <button class="toggle-btn" data-checkin="workout" data-val="true" onclick="setToggle('workout', true)">Yes</button>
                    <button class="toggle-btn" data-checkin="workout" data-val="false" onclick="setToggle('workout', false)">No</button>
                </div>
            </div>

            <div class="card toggle-question">
                <div class="toggle-label">Did you take creatine today?</div>
                <div class="toggle-group">
                    <button class="toggle-btn" data-checkin="creatine" data-val="true" onclick="setToggle('creatine', true)">Yes</button>
                    <button class="toggle-btn" data-checkin="creatine" data-val="false" onclick="setToggle('creatine', false)">No</button>
                </div>
            </div>

            <div class="card toggle-question">
                <div class="toggle-label">Were you on work today?</div>
                <div class="toggle-group">
                    <button class="toggle-btn" data-checkin="work" data-val="true" onclick="setToggle('work', true)">Yes</button>
                    <button class="toggle-btn" data-checkin="work" data-val="false" onclick="setToggle('work', false)">No</button>
                </div>
            </div>

            <div class="card">
                <div class="toggle-label">Rate the day</div>
                <div class="slider-container">
                    <div class="slider-value" id="rating-display">5.0</div>
                    <input type="range" id="rating-slider" min="1" max="10" step="0.1" value="5.0" oninput="updateRatingDisplay()">
                    <div class="slider-labels">
                        <span>1</span>
                        <span>10</span>
                    </div>
                </div>
            </div>

            <div class="checkin-buttons">
                <button class="btn-primary" id="btn-checkin-save">Save & Finish</button>
                <button class="btn-skip" id="btn-checkin-skip">Skip</button>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div class="tab-panel" id="panel-history">
            <div class="history-header">
                <span class="card-label">Saved Entries</span>
                <span class="history-count" id="history-count">0 entries</span>
            </div>
            <div id="history-list"></div>
            <div class="empty-state" id="history-empty">
                No entries saved yet.<br>Go to the Input tab to add your first entry.
            </div>
        </div>

        <!-- CHARTS TAB -->
        <div class="tab-panel" id="panel-charts">
            <div id="charts-content">
                <div class="chart-section">
                    <div class="card">
                        <div class="card-label">Total Screen Time</div>
                        <canvas id="chart-total"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="card">
                        <div class="card-label">App Breakdown</div>
                        <canvas id="chart-breakdown"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="card">
                        <div class="card-label">Average Daily by App</div>
                        <canvas id="chart-averages"></canvas>
                    </div>
                </div>
                <div class="chart-section" id="section-rating">
                    <div class="card">
                        <div class="card-label">Day Rating Over Time</div>
                        <canvas id="chart-rating"></canvas>
                    </div>
                </div>
                <div class="chart-section" id="section-habits">
                    <div class="card">
                        <div class="card-label">Daily Habits Frequency</div>
                        <canvas id="chart-habits"></canvas>
                    </div>
                </div>
            </div>
            <div class="empty-state" id="chart-empty">
                Need at least 2 saved entries to show trends.<br>Start logging your screen time on the Input tab.
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- Configuration ---
        const STORAGE_KEY = 'screenTimeData';
        const APPS = [
            { id: 'facebook',  label: 'Facebook',  color: '#1877f2' },
            { id: 'instagram', label: 'Instagram', color: '#e6683c' },
            { id: 'snapchat',  label: 'Snapchat',  color: '#d4c800' },
            { id: 'news',      label: 'News',      color: '#ff3b30' },
            { id: 'chess',     label: 'Chess',     color: '#4a752c' },
            { id: 'games',     label: 'Games',     color: '#5856d6' },
            { id: 'youtube',   label: 'YouTube',   color: '#ff0000' }
        ];
        const OTHER_COLOR = '#8e8e93';

        // Current check-in state
        let checkinState = { workout: null, creatine: null, work: null, rating: 5.0 };
        let checkinDateStr = null;

        // --- Data Layer ---
        function loadAllData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return { entries: {} };
                return JSON.parse(raw);
            } catch (e) {
                return { entries: {} };
            }
        }

        function persistData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function saveEntry(dateStr) {
            const data = loadAllData();
            const existing = data.entries[dateStr];
            const entry = {
                total: { h: getVal('total-h'), m: getVal('total-m') },
                apps: {}
            };
            APPS.forEach(app => {
                const h = parseInt(document.querySelector(`input[data-app="${app.id}"][data-unit="h"]`).value) || 0;
                const m = parseInt(document.querySelector(`input[data-app="${app.id}"][data-unit="m"]`).value) || 0;
                entry.apps[app.id] = { h, m };
            });
            // Preserve existing checkin data if present
            if (existing && existing.checkin) {
                entry.checkin = existing.checkin;
            }
            data.entries[dateStr] = entry;
            persistData(data);
        }

        function saveCheckin(dateStr) {
            const data = loadAllData();
            if (!data.entries[dateStr]) return;
            data.entries[dateStr].checkin = {
                workout: checkinState.workout,
                creatine: checkinState.creatine,
                work: checkinState.work,
                rating: parseFloat(document.getElementById('rating-slider').value)
            };
            persistData(data);
        }

        function deleteEntry(dateStr) {
            const data = loadAllData();
            delete data.entries[dateStr];
            persistData(data);
        }

        function loadEntryToForm(dateStr) {
            const data = loadAllData();
            const entry = data.entries[dateStr];
            const status = document.getElementById('date-status');
            if (entry) {
                document.getElementById('total-h').value = entry.total.h || '';
                document.getElementById('total-m').value = entry.total.m || '';
                APPS.forEach(app => {
                    const appData = entry.apps[app.id];
                    document.querySelector(`input[data-app="${app.id}"][data-unit="h"]`).value = appData?.h || '';
                    document.querySelector(`input[data-app="${app.id}"][data-unit="m"]`).value = appData?.m || '';
                });
                status.textContent = 'Saved entry loaded';
            } else {
                clearForm();
                status.textContent = 'No data for this date';
            }
            calculate();
        }

        function clearForm() {
            document.getElementById('total-h').value = '';
            document.getElementById('total-m').value = '';
            document.querySelectorAll('.app-time').forEach(input => input.value = '');
        }

        // --- Calculate ---
        function getVal(id) {
            const v = parseInt(document.getElementById(id).value, 10);
            return isNaN(v) ? 0 : v;
        }

        function calculate() {
            const totalMinutes = getVal('total-h') * 60 + getVal('total-m');
            let appMinutes = 0;

            APPS.forEach(app => {
                const h = document.querySelector(`input[data-app="${app.id}"][data-unit="h"]`);
                const m = document.querySelector(`input[data-app="${app.id}"][data-unit="m"]`);
                appMinutes += (parseInt(h.value, 10) || 0) * 60 + (parseInt(m.value, 10) || 0);
            });

            const otherMinutes = totalMinutes - appMinutes;
            const warning = document.getElementById('warning');
            const display = document.getElementById('other-display');
            const summary = document.getElementById('summary');

            if (otherMinutes < 0) {
                warning.style.display = 'block';
                const absMin = Math.abs(otherMinutes);
                display.innerHTML = `-${Math.floor(absMin / 60)}<span class="unit">h</span> ${absMin % 60}<span class="unit">m</span>`;
            } else {
                warning.style.display = 'none';
                display.innerHTML = `${Math.floor(otherMinutes / 60)}<span class="unit">h</span> ${otherMinutes % 60}<span class="unit">m</span>`;
            }

            if (totalMinutes > 0) {
                summary.textContent = `${appMinutes} of ${totalMinutes} minutes accounted for`;
            } else {
                summary.textContent = '';
            }
        }

        // --- Tab Switching ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn =>
                btn.classList.toggle('active', btn.dataset.tab === tabName)
            );
            document.querySelectorAll('.tab-panel').forEach(panel =>
                panel.classList.toggle('active', panel.id === 'panel-' + tabName)
            );
            if (tabName === 'history') renderHistory();
            if (tabName === 'charts') renderCharts();
        }

        // --- Toast ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // --- Date helpers ---
        function getTodayStr() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatShortDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // --- Check-in ---
        function showCheckin(dateStr) {
            checkinDateStr = dateStr;
            // Hide tab bar and all tab panels
            document.getElementById('tab-bar').style.display = 'none';
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            // Show checkin panel
            document.getElementById('panel-checkin').classList.add('active');
            document.getElementById('checkin-date-display').textContent = formatDate(dateStr);

            // Load existing checkin data if present
            const data = loadAllData();
            const entry = data.entries[dateStr];
            if (entry && entry.checkin) {
                checkinState.workout = entry.checkin.workout;
                checkinState.creatine = entry.checkin.creatine;
                checkinState.work = entry.checkin.work;
                checkinState.rating = entry.checkin.rating ?? 5.0;
            } else {
                checkinState = { workout: null, creatine: null, work: null, rating: 5.0 };
            }

            // Update UI
            updateToggleUI('workout', checkinState.workout);
            updateToggleUI('creatine', checkinState.creatine);
            updateToggleUI('work', checkinState.work);
            document.getElementById('rating-slider').value = checkinState.rating;
            updateRatingDisplay();
        }

        function hideCheckin() {
            document.getElementById('panel-checkin').classList.remove('active');
            document.getElementById('tab-bar').style.display = 'flex';
            switchTab('input');
        }

        function setToggle(field, value) {
            checkinState[field] = value;
            updateToggleUI(field, value);
        }

        function updateToggleUI(field, value) {
            const btns = document.querySelectorAll(`.toggle-btn[data-checkin="${field}"]`);
            btns.forEach(btn => {
                btn.classList.remove('selected-yes', 'selected-no');
                const btnVal = btn.dataset.val === 'true';
                if (value === true && btnVal) btn.classList.add('selected-yes');
                if (value === false && !btnVal) btn.classList.add('selected-no');
            });
        }

        function updateRatingDisplay() {
            document.getElementById('rating-display').textContent = parseFloat(document.getElementById('rating-slider').value).toFixed(1);
        }

        // --- History ---
        function renderHistory() {
            const data = loadAllData();
            const dates = Object.keys(data.entries).sort().reverse();
            const listEl = document.getElementById('history-list');
            const emptyEl = document.getElementById('history-empty');
            const countEl = document.getElementById('history-count');

            countEl.textContent = dates.length + (dates.length === 1 ? ' entry' : ' entries');

            if (dates.length === 0) {
                listEl.innerHTML = '';
                emptyEl.style.display = 'block';
                return;
            }
            emptyEl.style.display = 'none';

            listEl.innerHTML = dates.map(dateStr => {
                const entry = data.entries[dateStr];
                const th = entry.total.h || 0;
                const tm = entry.total.m || 0;

                const pills = APPS.map(app => {
                    const a = entry.apps[app.id];
                    const mins = (a?.h || 0) * 60 + (a?.m || 0);
                    if (mins === 0) return '';
                    const snapClass = app.id === 'snapchat' ? ' snap-pill' : '';
                    return `<span class="app-pill${snapClass}" style="background:${app.color}">${app.label} ${a.h}h${a.m}m</span>`;
                }).filter(Boolean).join('');

                const totalMin = th * 60 + tm;
                let appMin = 0;
                APPS.forEach(app => {
                    const a = entry.apps[app.id];
                    appMin += (a?.h || 0) * 60 + (a?.m || 0);
                });
                const otherMin = totalMin - appMin;
                let otherPill = '';
                if (otherMin > 0) {
                    otherPill = `<span class="app-pill" style="background:${OTHER_COLOR}">Other ${Math.floor(otherMin / 60)}h${otherMin % 60}m</span>`;
                }

                // Check-in badges
                let checkinHtml = '';
                if (entry.checkin) {
                    const c = entry.checkin;
                    const badges = [];
                    if (c.workout === true) badges.push('<span class="checkin-badge positive">Workout</span>');
                    else if (c.workout === false) badges.push('<span class="checkin-badge negative">No workout</span>');
                    if (c.creatine === true) badges.push('<span class="checkin-badge positive">Creatine</span>');
                    else if (c.creatine === false) badges.push('<span class="checkin-badge negative">No creatine</span>');
                    if (c.work === true) badges.push('<span class="checkin-badge positive">Work</span>');
                    else if (c.work === false) badges.push('<span class="checkin-badge negative">No work</span>');
                    if (c.rating != null) badges.push(`<span class="checkin-badge rating">${parseFloat(c.rating).toFixed(1)}/10</span>`);
                    if (badges.length) {
                        checkinHtml = `<div class="history-checkin">${badges.join('')}</div>`;
                    }
                }

                return `
                <div class="card history-entry">
                    <div class="history-entry-header">
                        <span class="history-date">${formatDate(dateStr)}</span>
                        <span class="history-total">${th}h ${tm}m</span>
                    </div>
                    <div class="history-apps">${pills}${otherPill}</div>
                    ${checkinHtml}
                    <div class="history-actions">
                        <button class="btn-small btn-edit" onclick="editEntry('${dateStr}')">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteEntryConfirm('${dateStr}')">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        function editEntry(dateStr) {
            document.getElementById('entry-date').value = dateStr;
            loadEntryToForm(dateStr);
            switchTab('input');
        }

        function deleteEntryConfirm(dateStr) {
            if (confirm(`Delete entry for ${formatDate(dateStr)}?`)) {
                deleteEntry(dateStr);
                renderHistory();
                if (document.getElementById('entry-date').value === dateStr) {
                    clearForm();
                    calculate();
                    document.getElementById('date-status').textContent = 'Entry deleted';
                }
                showToast('Entry deleted');
            }
        }

        // --- Charts ---
        let chartTotal = null;
        let chartBreakdown = null;
        let chartAverages = null;
        let chartRating = null;
        let chartHabits = null;

        function renderCharts() {
            if (typeof Chart === 'undefined') {
                document.getElementById('chart-empty').textContent = 'Chart library failed to load. Check your internet connection.';
                document.getElementById('chart-empty').style.display = 'block';
                document.getElementById('charts-content').style.display = 'none';
                return;
            }

            const data = loadAllData();
            const dates = Object.keys(data.entries).sort();

            if (dates.length < 2) {
                document.getElementById('chart-empty').style.display = 'block';
                document.getElementById('charts-content').style.display = 'none';
                return;
            }
            document.getElementById('chart-empty').style.display = 'none';
            document.getElementById('charts-content').style.display = 'block';

            const recent = dates.slice(-14);
            const labels = recent.map(formatShortDate);

            // Chart 1: Total screen time line
            const totalData = recent.map(d => {
                const e = data.entries[d];
                return +((e.total.h * 60 + e.total.m) / 60).toFixed(2);
            });

            if (chartTotal) chartTotal.destroy();
            chartTotal = new Chart(document.getElementById('chart-total'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total (hours)',
                        data: totalData,
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#007aff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Hours' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 2: Stacked bar - app breakdown
            const appDatasets = APPS.map(app => ({
                label: app.label,
                data: recent.map(d => {
                    const a = data.entries[d].apps[app.id];
                    return +(((a?.h || 0) * 60 + (a?.m || 0)) / 60).toFixed(2);
                }),
                backgroundColor: app.color
            }));

            appDatasets.push({
                label: 'Other',
                data: recent.map(d => {
                    const e = data.entries[d];
                    const totalMin = e.total.h * 60 + e.total.m;
                    let appMin = 0;
                    APPS.forEach(app => {
                        const a = e.apps[app.id];
                        appMin += (a?.h || 0) * 60 + (a?.m || 0);
                    });
                    return +(Math.max(0, totalMin - appMin) / 60).toFixed(2);
                }),
                backgroundColor: OTHER_COLOR
            });

            if (chartBreakdown) chartBreakdown.destroy();
            chartBreakdown = new Chart(document.getElementById('chart-breakdown'), {
                type: 'bar',
                data: { labels, datasets: appDatasets },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Hours' } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8 } }
                    }
                }
            });

            // Chart 3: Horizontal bar - average per app
            const allDates = Object.keys(data.entries);
            const count = allDates.length;
            const appTotals = APPS.map(() => 0);
            let otherTotal = 0;

            allDates.forEach(d => {
                const e = data.entries[d];
                const totalMin = e.total.h * 60 + e.total.m;
                let appMin = 0;
                APPS.forEach((app, i) => {
                    const a = e.apps[app.id];
                    const mins = (a?.h || 0) * 60 + (a?.m || 0);
                    appTotals[i] += mins;
                    appMin += mins;
                });
                otherTotal += Math.max(0, totalMin - appMin);
            });

            const avgLabels = [...APPS.map(a => a.label), 'Other'];
            const avgColors = [...APPS.map(a => a.color), OTHER_COLOR];
            const avgData = [...appTotals.map(t => +(t / count / 60).toFixed(1)), +(otherTotal / count / 60).toFixed(1)];

            if (chartAverages) chartAverages.destroy();
            chartAverages = new Chart(document.getElementById('chart-averages'), {
                type: 'bar',
                data: {
                    labels: avgLabels,
                    datasets: [{
                        data: avgData,
                        backgroundColor: avgColors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Avg Hours / Day' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 4: Day Rating Over Time
            const datesWithRating = recent.filter(d => data.entries[d].checkin?.rating != null);
            if (datesWithRating.length >= 2) {
                document.getElementById('section-rating').style.display = 'block';
                const ratingLabels = datesWithRating.map(formatShortDate);
                const ratingData = datesWithRating.map(d => parseFloat(data.entries[d].checkin.rating));

                if (chartRating) chartRating.destroy();
                chartRating = new Chart(document.getElementById('chart-rating'), {
                    type: 'line',
                    data: {
                        labels: ratingLabels,
                        datasets: [{
                            label: 'Day Rating',
                            data: ratingData,
                            borderColor: '#ff9500',
                            backgroundColor: 'rgba(255, 149, 0, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: '#ff9500'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { min: 1, max: 10, title: { display: true, text: 'Rating' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            } else {
                document.getElementById('section-rating').style.display = 'none';
                if (chartRating) { chartRating.destroy(); chartRating = null; }
            }

            // Chart 5: Daily Habits Frequency
            const datesWithCheckin = allDates.filter(d => data.entries[d].checkin);
            if (datesWithCheckin.length >= 1) {
                document.getElementById('section-habits').style.display = 'block';
                let workoutYes = 0, creatineYes = 0, workYes = 0;
                const cTotal = datesWithCheckin.length;
                datesWithCheckin.forEach(d => {
                    const c = data.entries[d].checkin;
                    if (c.workout === true) workoutYes++;
                    if (c.creatine === true) creatineYes++;
                    if (c.work === true) workYes++;
                });

                const habitsData = [
                    +((workoutYes / cTotal) * 100).toFixed(0),
                    +((creatineYes / cTotal) * 100).toFixed(0),
                    +((workYes / cTotal) * 100).toFixed(0)
                ];

                if (chartHabits) chartHabits.destroy();
                chartHabits = new Chart(document.getElementById('chart-habits'), {
                    type: 'bar',
                    data: {
                        labels: ['Workout', 'Creatine', 'Work'],
                        datasets: [{
                            data: habitsData,
                            backgroundColor: ['#34c759', '#007aff', '#ff9500']
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: { min: 0, max: 100, title: { display: true, text: '% of Days' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.raw + '% of days'
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('section-habits').style.display = 'none';
                if (chartHabits) { chartHabits.destroy(); chartHabits = null; }
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Date picker
            const dateInput = document.getElementById('entry-date');
            dateInput.value = getTodayStr();
            dateInput.addEventListener('change', () => loadEntryToForm(dateInput.value));

            // Today button
            document.getElementById('btn-today').addEventListener('click', () => {
                dateInput.value = getTodayStr();
                loadEntryToForm(getTodayStr());
            });

            // Save button -> saves screen time then shows checkin
            document.getElementById('btn-save').addEventListener('click', () => {
                const dateStr = dateInput.value;
                if (!dateStr) {
                    showToast('Please select a date');
                    return;
                }

                const totalMin = getVal('total-h') * 60 + getVal('total-m');
                if (totalMin === 0) {
                    if (!confirm('Total screen time is 0. Save anyway?')) return;
                }

                const data = loadAllData();
                if (data.entries[dateStr]) {
                    if (!confirm('An entry for this date already exists. Overwrite?')) return;
                }

                saveEntry(dateStr);
                showToast('Screen time saved');
                showCheckin(dateStr);
            });

            // Checkin save
            document.getElementById('btn-checkin-save').addEventListener('click', () => {
                if (checkinState.workout === null || checkinState.creatine === null || checkinState.work === null) {
                    showToast('Please answer all questions');
                    return;
                }
                saveCheckin(checkinDateStr);
                showToast('Check-in saved');
                hideCheckin();
            });

            // Checkin skip
            document.getElementById('btn-checkin-skip').addEventListener('click', () => {
                hideCheckin();
            });

            // Load today's entry if it exists
            loadEntryToForm(getTodayStr());
        });
    </script>
</body>
</html>
